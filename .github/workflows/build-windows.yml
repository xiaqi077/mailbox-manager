name: Build Windows EXE

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Install dependencies
      run: |
        pip install -r backend/requirements.txt pyinstaller
        cd frontend && npm install && npm run build
    
    - name: Build EXE
      run: |
        pyinstaller --noconfirm --clean --name MailboxManager --onedir ^
          --add-data "backend;backend" ^
          --add-data "frontend/dist;frontend/dist" ^
          --hidden-import fastapi ^
          --hidden-import uvicorn ^
          --hidden-import uvicorn.logging ^
          --hidden-import uvicorn.loops ^
          --hidden-import uvicorn.loops.auto ^
          --hidden-import uvicorn.protocols ^
          --hidden-import uvicorn.protocols.http ^
          --hidden-import uvicorn.protocols.http.auto ^
          --hidden-import uvicorn.protocols.websockets ^
          --hidden-import uvicorn.protocols.websockets.auto ^
          --hidden-import uvicorn.lifespan ^
          --hidden-import uvicorn.lifespan.on ^
          --hidden-import sqlalchemy ^
          --hidden-import sqlalchemy.ext.asyncio ^
          --hidden-import sqlalchemy.dialects.sqlite ^
          --hidden-import aiosqlite ^
          --hidden-import pydantic ^
          --hidden-import starlette ^
          --hidden-import httpx ^
          --hidden-import socks ^
          --hidden-import socksio ^
          --hidden-import email_validator ^
          --hidden-import passlib ^
          --hidden-import python_jose ^
          --hidden-import python_multipart ^
          --collect-all fastapi ^
          --collect-all uvicorn ^
          --collect-all sqlalchemy ^
          --collect-all pydantic ^
          launcher.py
    
    - name: Package
      run: Compress-Archive -Path dist/MailboxManager -DestinationPath MailboxManager-Windows.zip
    
    - uses: actions/upload-artifact@v4
      with:
        name: MailboxManager-Windows
        path: MailboxManager-Windows.zip
    
    - uses: softprops/action-gh-release@v2
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: MailboxManager-Windows.zip
        body: |
          ## Mailbox Manager v1.0.0 - Windows Edition
          
          ### 下载使用
          
          1. 下载 `MailboxManager-Windows.zip`
          2. 解压到任意目录
          3. 双击 `MailboxManager.exe` 启动
          4. 浏览器自动打开，使用 `admin` / `admin123` 登录
          
          ### 系统要求
          
          - Windows 10/11 (64-bit)
          - 无需安装 Python 或 Node.js
          
          ### 文件大小
          
          约 200-250 MB（包含所有依赖）
